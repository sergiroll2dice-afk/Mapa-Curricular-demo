<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaluador Curricular de Matemàtiques</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .level-button {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .level-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        /* Estils per al modal LLM */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal.open .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Avaluador Curricular de Matemàtiques (Compartit)</h1>
            <p class="mt-2 text-slate-600">Defineix el nivell de cada competència específica i visualitza la mitjana global.</p>
        </header>

        <!-- Indicador d'Usuari i Estat de Càrrega -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 max-w-4xl mx-auto">
            <p id="user-info" class="text-xs sm:text-sm text-slate-500 mb-2 sm:mb-0">
                Estat: <span id="loading-status" class="font-medium text-amber-600">Carregant dades...</span>
            </p>
            <p class="text-xs text-slate-500">
                ID d'Usuari: <span id="user-id-display" class="font-mono font-bold text-slate-700">...</span>
            </p>
        </div>

        <!-- Secció de Controls -->
        <div class="mb-8 max-w-4xl mx-auto flex flex-col sm:flex-row gap-4 items-center" id="controls-section">
             <div class="relative flex-grow w-full">
                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                     <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                 </div>
                 <input type="text" id="search-input"
                     class="block w-full bg-white border border-slate-300 rounded-lg py-3 pl-10 pr-4 text-slate-900 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                     placeholder="Cerca per competència, saber..." disabled>
             </div>
             <button id="reset-button" onclick="window.resetData()" class="bg-indigo-600 text-white font-semibold py-3 px-5 rounded-lg hover:bg-indigo-700 transition-colors duration-200 flex items-center justify-center gap-2 w-full sm:w-auto flex-shrink-0" disabled>
                 <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                 Restaurar a Valors del Currículum
             </button>
        </div>

        <!-- Contenidor de les targetes (Grid) -->
        <main id="curriculum-grid" class="card-container mb-12 min-h-64 flex justify-center items-center">
             <!-- Indicador de Càrrega Inicial -->
             <div id="initial-loading-spinner" class="flex flex-col items-center">
                <i data-lucide="loader-circle" class="h-12 w-12 text-indigo-500 animate-spin-slow"></i>
                <p class="mt-4 text-indigo-600 font-medium">Carregant avaluació des de Firestore...</p>
             </div>
        </main>
        
        <!-- Resum Visual (Gràfics) -->
        <section id="charts-section" class="hidden">
            <h2 class="text-3xl font-bold text-center text-slate-800 mb-8">Resum Visual</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Gràfic Radar -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                    <h3 class="text-xl font-bold text-center text-slate-700 mb-4">Nivell Mitjà per Competència (0-4)</h3>
                    <div class="relative h-96 w-full max-w-2xl mx-auto">
                        <canvas id="competencyChart"></canvas>
                    </div>
                </div>
                <!-- Gràfic de Barres -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                    <h3 class="text-xl font-bold text-center text-slate-700 mb-4">Nivell de Treball per Curs (C. Específiques)</h3>
                     <div class="relative h-96 w-full max-w-2xl mx-auto">
                         <canvas id="barChart"></canvas>
                     </div>
                </div>
            </div>
        </section>


        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>Avaluador Persistent de Matemàtiques, impulsat per Google Gemini.</p>
        </footer>
    </div>
    
    <!-- Modal per al Generador d'Activitats LLM -->
    <div id="llm-modal" class="modal fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center opacity-0 pointer-events-none">
        <div class="modal-content bg-white w-full max-w-4xl max-h-[90vh] mx-4 p-6 rounded-xl shadow-2xl flex flex-col">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-bold text-indigo-700" id="modal-title">Generant Contingut...</h2>
                <button onclick="closeLLMModal()" class="text-slate-400 hover:text-slate-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-body" class="overflow-y-auto flex-grow text-slate-700">
                <div id="llm-loader" class="flex flex-col items-center justify-center h-full min-h-40">
                    <i data-lucide="sparkles" class="h-10 w-10 text-indigo-500 animate-spin-slow"></i>
                    <p class="mt-4 text-indigo-600 font-medium">L'IA està generant objectius i activitats... Un moment, si us plau.</p>
                </div>
                <div id="llm-content" class="hidden prose max-w-none">
                    <!-- Contingut generat per l'LLM anirà aquí -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importacions de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables Globals de Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Configuració de l'API de Gemini ---
        const API_KEY = ""; // L'entorn Canvas proporciona la clau
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

        // Variables de l'Aplicació
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let saveTimeout = null;
        
        // Dades originals del currículum (Valors per defecte si no es troba res a Firestore)
        const originalData = [
            { saber: "Comptatge, Quantitat, Sentit de les operacions", especifica: [{ text: "C1 – Resoldre problemes i modelitzar", nivells: [4, 4, 3, 3] },{ text: "C2 – Argumentar solucions", nivells: [2, 3, 4, 4] }] },
            { saber: "Relacions, Raonament proporcional, Educació financera", especifica: [{ text: "C1 – Resoldre problemes i modelitzar", nivells: [4, 4, 4, 4] },{ text: "C3 – Formular conjectures", nivells: [1, 2, 3, 4] },{ text: "C5 – Raonar", nivells: [3, 3, 4, 4] }] },
            { saber: "Magnitud, Mesurament, Estimació i relacions", especifica: [{ text: "C1 – Resoldre problemes i modelitzar", nivells: [4, 4, 3, 2] },{ text: "C6 – Utilitzar instruments i eines", nivells: [3, 4, 3, 2] }] },
            { saber: "Formes geomètriques 2D i 3D, Moviments i transformacions, Visualització i modelització geomètrica", especifica: [{ text: "C1 – Modelitzar", nivells: [3, 3, 4, 4] },{ text: "C7 – Comunicar i representar coneixement", nivells: [2, 3, 3, 4] }] },
            { saber: "Localització i sistemes de representació", especifica: [{ text: "C1 – Resoldre problemes i modelitzar", nivells: [3, 3, 3, 3] },{ text: "C7 – Comunicar i representar", nivells: [3, 3, 4, 4] }] },
            { saber: "Tractament de dades, Estadística i probabilitat", especifica: [{ text: "C4 – Pensament computacional i dades", nivells: [1, 2, 3, 4] },{ text: "C8 – Fer servir recursos digitals", nivells: [2, 3, 4, 4] }] },
            { saber: "Resolució de problemes oberts i investigació", especifica: [{ text: "C1 – Resoldre problemes i modelitzar", nivells: [2, 3, 4, 4] },{ text: "C3 – Formular conjectures", nivells: [1, 2, 3, 4] }] },
            { saber: "Comunicació matemàtica (expressió, representació)", especifica: [{ text: "C7 – Comunicar i representar", nivells: [2, 3, 4, 4] },{ text: "C9 – Expressar emocions i actitud crítica", nivells: [1, 2, 2, 3] }] }
        ];
        
        // Criteris d'avaluació de matemàtiques de l'ESO (basats en els mapes curriculars)
        const mathCriteriaMap = {
            "C1": "Modelitza i resol problemes matemàtics de la vida quotidiana i de l'entorn, transferint els coneixements a situacions noves.",
            "C2": "Argumenta la validesa de les solucions obtingudes utilitzant un llenguatge matemàtic adequat i revisant la coherència amb el context.",
            "C3": "Formula i valida conjectures senzilles a partir de l'observació de patrons i la cerca de regularitats, utilitzant mètodes inductius i deductius.",
            "C4": "Utilitza el pensament computacional per organitzar, representar i analitzar dades, interpretant la informació estadística i probabilística per prendre decisions fonamentades.",
            "C5": "Aplica diferents tipus de raonament (deductiu, inductiu, analògic) i estratègies de cerca en contextos matemàtics per comprendre, justificar i comunicar processos.",
            "C6": "Selecciona i utilitza instruments i eines tecnològiques (calculadores, programari, apps) per a la manipulació, representació i visualització de dades i expressions matemàtiques.",
            "C7": "Comunica idees i processos matemàtics de manera clara, concisa i precisa utilitzant representacions diverses (gràfics, taules, símbols, models) i ajustant el registre al destinatari.",
            "C8": "Utilitza recursos digitals de manera responsable i crítica, valorant la seva aportació a l'aprenentatge i la resolució de problemes matemàtics complexes.",
            "C9": "Expressa una actitud positiva cap a les matemàtiques, gestionant les emocions i l'autoconeixement davant la incertesa, l'error o el repte, per afavorir l'aprenentatge."
        };

        let curriculumData; // Dades reestructurades inicials
        let workingData; // Dades actuals (amb nivells de l'usuari/per defecte)
        
        // Referències DOM i Charts
        const grid = document.getElementById('curriculum-grid');
        const searchInput = document.getElementById('search-input');
        const resetButton = document.getElementById('reset-button');
        const loadingStatus = document.getElementById('loading-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const initialLoadingSpinner = document.getElementById('initial-loading-spinner');
        const chartsSection = document.getElementById('charts-section');
        const chartCanvas = document.getElementById('competencyChart');
        const barChartCanvas = document.getElementById('barChart');
        const llmModal = document.getElementById('llm-modal');
        const llmLoader = document.getElementById('llm-loader');
        const llmContent = document.getElementById('llm-content');
        const modalTitle = document.getElementById('modal-title');
        
        let competencyChart = null;
        let barChart = null;
        
        // Descripcions dels nivells (Mantingudes)
        const levelDescriptions = [
            "Nivell 0: No es treballa aquesta competència en aquest curs.",
            "Nivell 1: Treball inicial de la competència, amb apropament als conceptes bàsics.",
            "Nivell 2: Desenvolupament bàsic de la competència, amb aplicació a problemes senzills i guiats.",
            "Nivell 3: Consolidació de la competència, permetent la resolució de problemes més complexos i l'autonomia parcial.",
            "Nivell 4: Domini i aprofundiment de la competència, amb capacitat d'aplicació creativa i resolució de situacions obertes."
        ];


        /* --- FUNCIONS D'UTLITAT DE L'API GEMINI I FIREBASE --- */

        /**
         * Realitza una petició fetch amb reintents utilitzant exponential backoff.
         */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < maxRetries - 1) { // 429 Too Many Requests
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        const errorBody = await response.text();
                        throw new Error(`API Error ${response.status}: ${errorBody}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Peticions a l'API esgotades.");
        }
        
        /**
         * Genera objectius i activitats estructurades utilitzant l'API de Gemini (Text).
         */
        window.generateActivities = async (competencyId, cursIndex) => {
            const item = workingData.find(c => c.id === competencyId);
            if (!item) return;

            openLLMModal();
            llmLoader.classList.remove('hidden');
            llmContent.classList.add('hidden');
            
            const courseOrdinal = ["1r", "2n", "3r", "4t"][cursIndex];
            const level = item.nivells[cursIndex];
            
            modalTitle.textContent = `✨ Objectius i Activitats: ${item.code} (${courseOrdinal} ESO, Nivell ${level})`;
            llmContent.innerHTML = '';
            
            // 1. Dades per al prompt
            const sabers = curriculumData.find(c => c.code === item.code).contexts.map(ctx => ctx.saber).join(', ');
            const criteriaText = item.criteriaText;
            
            // PROMPT DEL SISTEMA MODIFICAT PER ENFATITZAR LA RELACIÓ AMB ELS CRITERIS
            const systemPrompt = `Actua com un expert en currículum de matemàtiques de l'ESO (12-16 anys). La teva tasca és generar un llistat d'objectius d'aprenentatge i exemples concrets d'activitats per a una competència específica, relacionant-les directament amb els sabers proporcionats i, especialment, amb el Criteri d'Avaluació establert. La resposta ha de ser en català i ha de seguir l'esquema JSON estrictament. No inclouis cap text introductori fora de l'estructura JSON.`;
            
            const userQuery = `Per a la competència: "${item.code} - ${item.description}", amb el Criteri d'Avaluació: "${criteriaText}". Els sabers associats són: [${sabers}]. Genera 3 objectius d'aprenentatge i 3 exemples concrets d'activitats. Aquesta avaluació correspon al curs ${courseOrdinal} ESO amb un Nivell assignat de ${level} (on 0 és no es treballa i 4 és domini). Adapta la complexitat al curs, al nivell i al Criteri d'Avaluació.`;

            // 2. Esquema JSON per a una resposta estructurada
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    level_summary: { type: "STRING", description: "Breu resum (1 frase) de la complexitat que representa el Nivell assignat." },
                    learning_objectives: {
                        type: "ARRAY",
                        description: "3 Objectius d'aprenentatge concrets que l'alumne hauria d'assolir.",
                        items: { type: "STRING" }
                    },
                    suggested_activities: {
                        type: "ARRAY",
                        description: "3 Exemples concrets d'activitats a realitzar a classe o com a tasca.",
                        items: { type: "STRING" }
                    },
                    criteria_used: { type: "STRING", description: "El Criteri d'Avaluació utilitzat com a referència." }
                },
                required: ["level_summary", "learning_objectives", "suggested_activities", "criteria_used"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };

            try {
                const response = await fetchWithBackoff(TEXT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    llmContent.innerHTML = `<p class="text-red-600">⚠️ Error de format o contingut buit de l'API. Si us plau, torna a provar-ho.</p>`;
                } else {
                    const data = JSON.parse(jsonText);
                    
                    // Renderitzar el contingut
                    let html = `<p class="text-sm font-medium text-slate-500 mb-2">Criteri d'Avaluació de referència:</p>`;
                    html += `<p class="text-lg font-semibold mb-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-400">${data.criteria_used}</p>`;
                    html += `<p class="text-lg font-semibold mb-4 p-3 bg-emerald-50 rounded-lg border-l-4 border-emerald-400">${data.level_summary}</p>`;
                    
                    html += `<h3 class="text-xl font-bold text-slate-800 mt-6 mb-3 flex items-center"><i data-lucide="target" class="w-5 h-5 mr-2 text-emerald-600"></i> Objectius d'Aprenentatge</h3>`;
                    html += `<ul class="list-disc list-inside space-y-2 pl-4">`;
                    data.learning_objectives.forEach(obj => {
                        html += `<li class="text-base">${obj}</li>`;
                    });
                    html += `</ul>`;

                    html += `<h3 class="text-xl font-bold text-slate-800 mt-8 mb-3 flex items-center"><i data-lucide="activity" class="w-5 h-5 mr-2 text-amber-600"></i> Activitats Suggerides</h3>`;
                    html += `<ul class="list-decimal list-inside space-y-2 pl-4">`;
                    data.suggested_activities.forEach(act => {
                        html += `<li class="text-base">${act}</li>`;
                    });
                    html += `</ul>`;
                    
                    llmContent.innerHTML = html;
                    lucide.createIcons();
                }

            } catch (error) {
                console.error("Error durant la generació de contingut:", error);
                llmContent.innerHTML = `<p class="text-red-600">⚠️ Error: No s'ha pogut contactar amb el servei de l'IA (Error de xarxa/API). Si us plau, torna a provar-ho.</p>`;
            } finally {
                llmLoader.classList.add('hidden');
                llmContent.classList.remove('hidden');
            }
        };

        function openLLMModal() {
            llmModal.classList.add('open', 'opacity-100', 'pointer-events-auto');
            document.body.style.overflow = 'hidden'; // Evita el scroll del cos
            lucide.createIcons();
        }

        window.closeLLMModal = () => {
            llmModal.classList.remove('open', 'opacity-100', 'pointer-events-auto');
            document.body.style.overflow = '';
        }

        /* --- FUNCIONS DE FIREBASE I DADES EXISTENTS --- */

        function restructureData(original) {
            const competencyMap = {};
            original.forEach(saber => {
                saber.especifica.forEach(comp => {
                    const parts = comp.text.split('–');
                    const code = parts[0].trim();
                    let description = parts.slice(1).join('–').trim();

                    // Unificació de descripcions de C1 i C7 (per consistència)
                    if (code === 'C1') description = 'Resoldre problemes i modelitzar';
                    if (code === 'C7') description = 'Comunicar i representar';

                    if (!competencyMap[code]) {
                        competencyMap[code] = {
                            code,
                            description,
                            defaultNivells: comp.nivells, // Valors per defecte del currículum (per al reset)
                            nivells: [0, 0, 0, 0], // Inicia sempre a zero per defecte
                            contexts: [],
                            criteriaText: mathCriteriaMap[code] || "Criteri d'avaluació no trobat." // AFEGIT EL CRITERI
                        };
                    }
                    competencyMap[code].contexts.push({ saber: saber.saber });
                });
            });

            // Convertir el mapa a un array i ordenar-lo
            const restructured = Object.values(competencyMap);
            restructured.sort((a, b) => a.code.localeCompare(b.code, undefined, { numeric: true }));
            restructured.forEach((item, index) => item.id = index); // Afegim un ID numèric
            return restructured;
        }

        async function initFirebaseAndLoadData() {
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config is missing or empty.");
                 loadingStatus.textContent = "Error: Configuració de Firebase no disponible.";
                 curriculumData = restructureData(originalData);
                 workingData = JSON.parse(JSON.stringify(curriculumData));
                 handleReadyState();
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        isAuthReady = true;
                        
                        curriculumData = restructureData(originalData);
                        setupDataListener();
                        loadingStatus.textContent = "Connectat. Esperant dades compartides...";
                    } else {
                        console.log("No user signed in.");
                        loadingStatus.textContent = "Error d'autenticació. Usant dades per defecte (zeros).";
                        userId = 'anonymous-user';
                        userIdDisplay.textContent = userId;
                        curriculumData = restructureData(originalData);
                        workingData = JSON.parse(JSON.stringify(curriculumData));
                        handleReadyState();
                    }
                });

            } catch (error) {
                console.error("Error durant la inicialització de Firebase:", error);
                loadingStatus.textContent = `Error (${error.code}): No s'han pogut carregar les dades.`;
                curriculumData = restructureData(originalData);
                workingData = JSON.parse(JSON.stringify(curriculumData));
                handleReadyState();
            }
        }
        
        function setupDataListener() {
            // RUTA PÚBLICA (COMPARTIDA): Tothom amb el mateix appId veurà les mateixes dades.
            const docPath = `artifacts/${appId}/public/data/math_curriculum_evaluation/evaluation`;
            const userDocRef = doc(db, docPath);

            onSnapshot(userDocRef, (docSnapshot) => {
                if (!isAuthReady) return;

                if (docSnapshot.exists()) {
                    const savedData = docSnapshot.data().evaluationData;
                    // Mantenim els camps base de curriculumData (com el criteriaText)
                    workingData = curriculumData.map(item => {
                        const savedItem = savedData.find(s => s.code === item.code);
                        return {
                            ...item,
                            nivells: savedItem ? savedItem.nivells : item.nivells
                        };
                    });
                    
                    loadingStatus.textContent = "Dades compartides carregades correctament.";
                } else {
                    console.log("No hi ha dades guardades. Utilitzant valors inicials (zeros).");
                    // Quan no hi ha dades al document públic, carreguem els valors inicials del currículum (tots a 0)
                    workingData = JSON.parse(JSON.stringify(curriculumData)); 
                    // S'inicialitzen els nivells a 0 per defecte si no hi ha dades prèvies
                    workingData.forEach(comp => comp.nivells = [0, 0, 0, 0]);
                    loadingStatus.textContent = "Dades compartides carregades (Valors inicials a 0).";
                }
                handleReadyState();
            }, (error) => {
                console.error("Error al rebre l'instantània de Firestore:", error);
                loadingStatus.textContent = "Error de connexió a la base de dades.";
            });
        }
        
        function saveEvaluationData() {
             if (!isAuthReady || !db || !userId) {
                 console.warn("Intent de guardar abans que Firebase estigui llest.");
                 return;
             }
             
             clearTimeout(saveTimeout);
             saveTimeout = setTimeout(async () => {
                 // RUTA PÚBLICA (COMPARTIDA): Tothom amb el mateix appId escriurà al mateix lloc.
                 const docPath = `artifacts/${appId}/public/data/math_curriculum_evaluation/evaluation`;
                 const userDocRef = doc(db, docPath);
                 
                 try {
                     const dataToSave = workingData.map(item => ({
                         code: item.code,
                         nivells: item.nivells
                     }));

                     await setDoc(userDocRef, { 
                         evaluationData: dataToSave,
                         lastUpdated: new Date().toISOString()
                     }, { merge: false });

                     loadingStatus.textContent = "Dades guardades amb èxit i compartides.";
                 } catch (error) {
                     console.error("Error al guardar les dades a Firestore:", error);
                     loadingStatus.textContent = "Error al guardar les dades!";
                 }
             }, 500); // 500ms debounce
        }

        function handleReadyState() {
            initialLoadingSpinner.classList.add('hidden');
            grid.classList.remove('justify-center', 'items-center', 'flex', 'min-h-64');
            chartsSection.classList.remove('hidden');
            searchInput.disabled = false;
            resetButton.disabled = false;
            renderAll();
        }

        /* --- FUNCIONS DE RENDERITZACIÓ DE LA UI --- */

        function getLevelColor(level) {
            const colors = [ 
                'bg-slate-200 text-slate-700', // 0: No es treballa
                'bg-sky-100 text-sky-800',     // 1: Nivell Baix
                'bg-sky-300 text-sky-900',     // 2: Nivell Mig-Baix
                'bg-sky-500 text-white',       // 3: Nivell Mig-Alt
                'bg-sky-600 text-white'        // 4: Nivell Alt
            ];
            return colors[level] || colors[0];
        }

        function renderCards(dataToRender) {
            const currentData = dataToRender || workingData;
            grid.innerHTML = '';
            
            if (!currentData || currentData.length === 0) {
                grid.innerHTML = `<p class="text-slate-500 col-span-full text-center p-8">No s'han trobat resultats o les dades encara no s'han carregat.</p>`;
                return;
            }

            currentData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-lg flex flex-col border border-transparent hover:border-indigo-400 hover:shadow-xl transition-all';
                
                const levelIndicators = item.nivells.map((nivell, cursIndex) => {
                    const courseOrdinal = ["1r", "2n", "3r", "4t"][cursIndex];
                    const colorClass = getLevelColor(nivell);
                    
                    return `<div class="flex flex-col items-center flex-1">
                                <span class="text-xs font-semibold text-slate-500 mb-1">${courseOrdinal} ESO</span>
                                <div class="flex items-center gap-1">
                                    <button class="w-12 h-12 rounded-full level-button ${colorClass} font-bold text-lg flex items-center justify-center shadow-md" 
                                        title="${courseOrdinal} ESO: Nivell ${nivell}. Fes clic per canviar." 
                                        onclick="window.updateLevel(${item.id}, ${cursIndex})">
                                        ${nivell}
                                    </button>
                                </div>
                            </div>`;
                }).join('');
                
                const originalComp = curriculumData.find(c => c.code === item.code);
                const contextHtml = originalComp ? originalComp.contexts.map(ctx => `
                    <div class="py-1 border-t border-slate-100 last:border-b last:mb-0">
                        <h4 class="text-sm text-slate-600 pl-2">
                           <i data-lucide="check-circle" class="w-4 h-4 inline-block text-emerald-500 mr-1"></i>
                           ${ctx.saber}
                        </h4>
                    </div>`).join('') : '';

                card.innerHTML = `
                    <div class="flex-grow">
                        <h2 class="text-xl font-bold text-indigo-700 mb-4">${item.code} – ${item.description}</h2>
                        
                        <!-- Criteri d'Avaluació associat -->
                        <div class="text-sm text-slate-600 mb-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-300">
                             <span class="font-semibold text-indigo-700">Criteri:</span> ${item.criteriaText}
                        </div>

                        <!-- Botons de Nivell -->
                        <div class="my-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <h3 class="text-sm font-semibold text-slate-600 mb-3 text-center">Nivell de Treball Assignat</h3>
                            <div class="flex justify-around items-center space-x-2">${levelIndicators}</div>
                        </div>
                        
                        <!-- Botó LLM per generar activitats (Només cal un botó per competència, que analitza els 4 cursos) -->
                        <div class="my-4">
                            <button onclick="window.generateActivities(${item.id}, 0)" 
                                    class="w-full bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-600 transition-colors duration-200 flex items-center justify-center gap-2 shadow-md">
                                <i data-lucide="sparkles" class="w-5 h-5"></i>
                                ✨ Generar Objectius i Activitats
                            </button>
                        </div>

                        <!-- Sabers associats -->
                        <div>
                            <h3 class="text-md font-semibold text-slate-700 mb-2 p-2 bg-slate-100 rounded-t-lg border-b">
                                <i data-lucide="list-checks" class="w-5 h-5 inline-block mr-2 text-slate-500"></i>
                                Sabers de referència:
                            </h3>
                            <div class="transition-all duration-300 pb-2">
                                ${contextHtml}
                            </div>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }
        
        window.updateLevel = (competencyId, cursIndex) => {
            const competencyToUpdate = workingData.find(c => c.id === competencyId);
            if (!competencyToUpdate) return;
            
            let currentLevel = competencyToUpdate.nivells[cursIndex];
            currentLevel = (currentLevel + 1) % 5; // Cycles 0 -> 1 -> 2 -> 3 -> 4 -> 0
            competencyToUpdate.nivells[cursIndex] = currentLevel;
            
            renderAll();
            saveEvaluationData();
        };

        function calculateRadarChartData() {
            const labels = workingData.map(c => c.code);
            const data = workingData.map(c => {
                const totalLevel = c.nivells.reduce((a, b) => a + b, 0);
                return totalLevel / 4; // Mitjana sobre 4 cursos
            });
            return { labels, data };
        }
        
        function calculateBarChartData() {
            const labels = workingData.map(c => c.code);
            const courses = ["1r ESO", "2n ESO", "3r ESO", "4t ESO"];
            const backgroundColors = [
                'rgba(148, 163, 184, 0.9)',
                'rgba(56, 189, 248, 0.9)',
                'rgba(99, 102, 241, 0.9)',
                'rgba(79, 70, 229, 0.9)'
            ];
            const borderColors = [
                'rgba(148, 163, 184, 1)',
                'rgba(56, 189, 248, 1)',
                'rgba(99, 102, 241, 1)',
                'rgba(79, 70, 229, 1)'
            ];

            const datasets = courses.map((course, index) => {
                return {
                    label: course,
                    data: workingData.map(c => c.nivells[index]),
                    backgroundColor: backgroundColors[index],
                    borderColor: borderColors[index],
                    borderWidth: 1
                };
            });

            return { labels, datasets };
        }


        function renderRadarChart() {
            const { labels, data } = calculateRadarChartData();
            if (competencyChart) {
                competencyChart.destroy();
            }
            competencyChart = new Chart(chartCanvas, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nivell Mitjà Global',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: { r: { angleLines: { color: 'rgba(0, 0, 0, 0.1)' }, grid: { color: 'rgba(0, 0, 0, 0.1)' }, pointLabels: { font: { size: 12, weight: 'bold' } }, ticks: { backdropColor: 'rgba(255, 255, 255, 0.75)', color: '#4b5563', stepSize: 1, font: { weight: 'bold' } }, suggestedMin: 0, suggestedMax: 4 } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => `Nivell mitjà: ${context.raw.toFixed(2)}` } } }
                }
            });
        }
        
        function renderBarChart() {
            const { labels, datasets } = calculateBarChartData();
            if (barChart) {
                barChart.destroy();
            }
            barChart = new Chart(barChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 4, ticks: { stepSize: 1, color: '#4b5563' }, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                        x: { ticks: { color: '#4b5563', autoSkip: false, maxRotation: 0, minRotation: 0 }, grid: { display: false }, stacked: false }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: (context) => `${context.dataset.label}: Nivell ${context.raw}` } }
                    }
                }
            });
        }
        
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (!workingData) return;
            
            if (!searchTerm) {
                renderCards(workingData);
                return;
            }
            const filteredData = workingData.filter(item => {
                const competencyMatch = `${item.code} ${item.description} ${item.criteriaText}`.toLowerCase().includes(searchTerm);
                const originalComp = curriculumData.find(c => c.code === item.code);
                const contextMatch = originalComp && originalComp.contexts.some(ctx => 
                    ctx.saber.toLowerCase().includes(searchTerm)
                );
                return competencyMatch || contextMatch;
            });
            renderCards(filteredData);
        }

        window.resetData = () => {
             // Restaurar als valors de nivell per defecte que es van trobar al currículum original.
             workingData = JSON.parse(JSON.stringify(curriculumData)); 
             workingData.forEach(comp => {
                 comp.nivells = [...comp.defaultNivells];
             });

             searchInput.value = '';
             renderAll();
             saveEvaluationData();
             loadingStatus.textContent = "Dades restaurades als valors curriculars originals.";
        }
        
        function renderAll(){
            if (!workingData) return;
            handleSearch();
            renderRadarChart();
            renderBarChart();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initFirebaseAndLoadData();
            searchInput.addEventListener('input', handleSearch);
        });

    </script>
</body>
</html>